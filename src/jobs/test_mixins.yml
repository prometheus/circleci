---
description: >
  Test jsonnet mixins

executor:
  name: golang
  version: << parameters.version >>
  resource_class: << parameters.resource_class >>

parameters:
  mixin_path:
    description: Path to the mixin within the repo.
    default: monitoring-mixin
    type: string
  resource_class:
    description: Resource class
    type: string
    default: medium
  version:
    description: Go version
    type: string

working_directory: ~/project/<< parameters.mixin_path >>

steps:
- setup_environment
- run: >
    go install -mod=readonly
      github.com/google/go-jsonnet/cmd/jsonnet
      github.com/google/go-jsonnet/cmd/jsonnetfmt
      github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb
      github.com/prometheus/prometheus/cmd/promtool
- run: make clean
- run: jb install
- run: make
- run: git diff --exit-code
