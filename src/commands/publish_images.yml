description: >
  Build and publish images to a container image registry.

parameters:
  registry:
    description: Registry address
    type: string
  organization:
    description: Registry organization
    type: string
  login_variable:
    description: Environment variable holding the registry login
    type: env_var_name
  password_variable:
    description: Environment variable holding the registry password
    type: env_var_name
  dockerfile_path:
    description: Path to Dockerfile
    type: string
    default: ""
  dockerbuild_context:
    description: Path to Dockerbuild context
    type: string
    default: ""
  container_image_name:
    description: Name of the container image
    type: string
    default: ""


steps:
- when:
    condition: << parameters.dockerfile_path >>
    steps:
    - run: echo "export DOCKERFILE_PATH=<< parameters.dockerfile_path >>" >> $BASH_ENV
- when:
    condition: << parameters.container_image_name >>
    steps:
    - run: echo "export DOCKER_IMAGE_NAME=<< parameters.container_image_name >>" >> $BASH_ENV
- when:
    condition: << parameters.dockerbuild_context >>
    steps:
    - run: echo "export DOCKERBUILD_CONTEXT=<< parameters.dockerbuild_context >>" >> $BASH_ENV
- run: make docker DOCKER_REPO=<< parameters.registry >>/<< parameters.organization >>
- run: docker images
- run: echo $<< parameters.password_variable >> | docker login -u $<< parameters.login_variable >> --password-stdin << parameters.registry >>
- run: make docker-publish DOCKER_REPO=<< parameters.registry >>/<< parameters.organization >>
- run: make docker-manifest DOCKER_REPO=<< parameters.registry >>/<< parameters.organization >>
